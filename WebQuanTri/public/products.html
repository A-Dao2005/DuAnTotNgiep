<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω s·∫£n ph·∫©m</title>
  <link rel="stylesheet" href="products.css">
  <style>
    #modal, #modal-delete {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
    }
    .modal-content input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .modal-content button {
      margin-right: 10px;
    }
  </style>
</head>
<body>
<div class="sidebar">
  <h3>Admin Panel</h3>
  <a href="products.html" class="active">üì¶ Qu·∫£n l√Ω s·∫£n ph·∫©m</a>
  <a href="categories.html">üîç Qu·∫£n l√Ω danh m·ª•c</a>
  <a href="orders.html">üìã ƒê∆°n h√†ng</a>
  <a href="users.html" class="active">üë§ Kh√°ch h√†ng</a>
  <a href="chat.html">üí¨ Chat kh√°ch h√†ng</a>
  <a href="statistics.html">üìä Th·ªëng k√™</a>
  <a href="history.html">üìÅ L·ªãch s·ª≠ ƒë∆°n h√†ng</a>
  <a href="settings.html">‚öôÔ∏è C√†i ƒë·∫∑t t√†i kho·∫£n</a>
 
</div>

<h2>üì¶ Qu·∫£n l√Ω s·∫£n ph·∫©m</h2>
<button onclick="openModal()">+ Th√™m s·∫£n ph·∫©m</button>

<table>
  <thead>
    <tr>
      <th>·∫¢nh</th>
      <th>M√£ SP</th>
      <th>T√™n</th>
      <th>Gi√°</th>
      <th>Gi√° c≈©</th>
      <th>ƒê√£ b√°n</th>
      <th>% Sale</th>
      <th>Y√™u th√≠ch</th>
      <th>Shop</th>
      <th>Ph√¢n lo·∫°i</th>
      <th>H√†nh ƒë·ªông</th>
    </tr>
  </thead>
  <tbody id="product-body"></tbody>
</table>

<div id="modal">
  <div class="modal-content">
    <h3 id="modal-title">Th√™m s·∫£n ph·∫©m</h3>
    <input id="image" placeholder="Link ·∫£nh">
    <input id="img" placeholder="Link ·∫£nh (img, tu·ª≥ ch·ªçn)">
    <input id="maSP" placeholder="M√£ SP">
    <input id="tenSanPham" placeholder="T√™n s·∫£n ph·∫©m">
    <input id="giaSanPham" placeholder="Gi√°">
    <input id="priceOld" placeholder="Gi√° c≈©">
    <input id="sold" placeholder="ƒê√£ b√°n" type="number">
    <input id="isSale" placeholder="% gi·∫£m gi√°" type="number">
    <input id="isFavorite" placeholder="Y√™u th√≠ch? true/false">
    <input id="shop" placeholder="T√™n shop">
    <select id="phanLoai"></select>
    <button onclick="saveProduct()">L∆∞u</button>
    <button onclick="closeModal()">H·ªßy</button>
  </div>
</div>

<div id="modal-delete">
  <div class="modal-content">
    <h3>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° s·∫£n ph·∫©m n√†y?</h3>
    <button onclick="confirmDelete()">Xo√°</button>
    <button onclick="closeDeleteModal()">H·ªßy</button>
  </div>
</div>

<script>
  const API_URL = 'http://192.168.1.10:5000/api/products';
  let editId = null;
  let deleteId = null;

  // Fetch danh m·ª•c ƒë·ªông v√† render select
  async function loadCategories(selectedValue = '') {
    const res = await fetch('/api/categories');
    const cats = await res.json();
    const select = document.getElementById('phanLoai');
    select.innerHTML = '';
    cats.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat.key;
      opt.textContent = cat.label;
      if (cat.key === selectedValue) opt.selected = true;
      select.appendChild(opt);
    });
  }

  function openModal(product = null) {
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('modal-title').innerText = product ? 'S·ª≠a s·∫£n ph·∫©m' : 'Th√™m s·∫£n ph·∫©m';
    editId = product?._id || null;

    document.getElementById('image').value = product?.image || '';
    document.getElementById('img').value = product?.img || '';
    document.getElementById('maSP').value = product?.maSP || '';
    document.getElementById('tenSanPham').value = product?.tenSanPham || '';
    document.getElementById('giaSanPham').value = product?.giaSanPham || '';
    document.getElementById('priceOld').value = product?.priceOld || '';
    document.getElementById('sold').value = product?.sold || '';
    document.getElementById('isSale').value = product?.isSale || '';
    document.getElementById('isFavorite').value = product?.isFavorite || '';
    document.getElementById('shop').value = product?.shop || '';
    // G·ªçi loadCategories v√† set value ƒë√∫ng khi s·ª≠a
    loadCategories(product?.phanLoai || '');
  }

  function closeModal() {
    document.getElementById('modal').style.display = 'none';
    editId = null;
  }

  function openDeleteModal(id) {
    deleteId = id;
    document.getElementById('modal-delete').style.display = 'flex';
  }

  function closeDeleteModal() {
    deleteId = null;
    document.getElementById('modal-delete').style.display = 'none';
  }

  async function confirmDelete() {
    await fetch(`${API_URL}/${deleteId}`, { method: 'DELETE' });
    alert('Xo√° th√†nh c√¥ng');
    closeDeleteModal();
    fetchProducts();
  }

  async function fetchProducts() {
    const res = await fetch(API_URL);
    const data = await res.json();
    const tbody = document.getElementById('product-body');
    tbody.innerHTML = '';

    data.forEach(p => {
      tbody.innerHTML += `
        <tr data-id="${p._id}">
          <td><img src="${p.image || p.img}" alt="·∫¢nh" width="60"></td>
          <td>${p.maSP}</td>
          <td>${p.tenSanPham}</td>
          <td>${p.giaSanPham}‚Ç´</td>
          <td>${p.priceOld || ''}</td>
          <td>${p.sold || 0}</td>
          <td>${p.isSale || 0}</td>
          <td>${p.isFavorite ? '‚úîÔ∏è' : ''}</td>
          <td>${p.shop || ''}</td>
          <td>${p.phanLoai}</td>
          <td>
            <button onclick='editProduct(${JSON.stringify(p)})'>S·ª≠a</button>
            <button onclick="openDeleteModal('${p._id}')">Xo√°</button>
          </td>
        </tr>
      `;
    });
  }

  function editProduct(product) {
    openModal(product);
  }

  async function saveProduct() {
    const image = document.getElementById('image').value;
    const img = document.getElementById('img').value;
    const maSP = document.getElementById('maSP').value;
    const tenSanPham = document.getElementById('tenSanPham').value;
    const giaSanPham = document.getElementById('giaSanPham').value;
    const priceOld = document.getElementById('priceOld').value;
    const sold = Number(document.getElementById('sold').value) || 0;
    const isSale = Number(document.getElementById('isSale').value) || 0;
    const isFavorite = document.getElementById('isFavorite').value === 'true';
    const shop = document.getElementById('shop').value;
    const phanLoai = document.getElementById('phanLoai').value;

    const method = editId ? 'PUT' : 'POST';
    const url = editId ? `${API_URL}/${editId}` : API_URL;

    await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image, img, maSP, tenSanPham, giaSanPham, priceOld, sold, isSale, isFavorite, shop, phanLoai })
    });

    alert(editId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m th√†nh c√¥ng!');
    closeModal();
    fetchProducts();
  }

  // Khi trang load, fetch danh m·ª•c v√† s·∫£n ph·∫©m
  window.onload = function() {
    loadCategories();
    fetchProducts();
  };
</script>
</body>
</html>